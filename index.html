<!DOCTYPE html>
<html>
<head>
    <script type="text/javascript" src="https://unpkg.com/read-excel-file@4.x/bundle/read-excel-file.min.js"
            defer></script>
    <title>Upload Excel</title>
</head>
<body>
<div>
    <input type="file" name="excelfile" id="excelfile" accept=".xlsx">
    <input type="reset" value="reset">
</div>

<table id="exceltable"></table>

</body>
<script>

    let inputexcelfile = document.getElementById("excelfile");
    let exceltable = document.getElementById("exceltable");

    inputexcelfile.addEventListener('change', () => {

        let allInputsToFill = {};
        exceltable.innerHTML = "";

        readXlsxFile(inputexcelfile.files[0]).then((rows) => {

            const fileOccurrences = {};

            let trEnTete = document.createElement('tr');
            for (let i = 0; i < 4; i++) {
                let th = document.createElement('th');
                th.textContent = rows[0][i];
                trEnTete.appendChild(th);
            }
            exceltable.appendChild(trEnTete);

            // je retire la première occurence qui ne sont que les en-têtes du excel
            rows.shift();

            rows.forEach(([fileName, adminName, timeToStart, timeToFinish]) => {
                let tr = document.createElement('tr');

                let ADMINAME;
                let CONTACT;
                let HORAIRE;

                // je retire tout ce qui ne m'intéresse pas dans la string fileName
                const regex = /CAP AMPERE-MUT-(.{7})/;
                let goodName = regex.exec(fileName);

                fileName = goodName[1]; // fileName represente en faite le nom de salle

                // appendChild du nom de salle
                const tdFileName = document.createElement('td');
                tdFileName.textContent = fileName;
                tr.appendChild(tdFileName);
                //

                // appendChild du nom sans le modifier (pas d'intérêt de le modifier ici)
                const tdAdminName = document.createElement('td');
                tdAdminName.textContent = adminName;
                tr.appendChild(tdAdminName);
                //

                // je retire ce qui n'est pas utile dans la string adminName
                if (adminName.includes(" - externe")) adminName = adminName.replace(" - externe", "");
                // je fais un saut de ligne entre le nom et le prenom
                if (adminName.includes(" ")) adminName = adminName.replace(" ", "\n");

                // je vérifie si c'est heure d'été ou hiver (problème de formatage avec excel)
                let offset = timeToStart.getTimezoneOffset();
                offset === -60 ? timeToStart.setHours(timeToStart.getHours() + 11) : timeToStart.setHours(timeToStart.getHours() + 10);
                offset = timeToFinish.getTimezoneOffset();
                offset === -60 ? timeToFinish.setHours(timeToFinish.getHours() + 11) : timeToFinish.setHours(timeToFinish.getHours() + 10);

                // je formatte l'heure comme il faut
                const timeBegin = timeToStart.getHours().toString().padStart(2, "0") + ":" + timeToStart.getMinutes().toString().padStart(2, "0")
                const timeEnd = timeToFinish.getHours().toString().padStart(2, "0") + ":" + timeToFinish.getMinutes().toString().padStart(2, "0")

                // appendChild de l'heure de départ
                const tdTimeBegin = document.createElement('td');
                tdTimeBegin.textContent = timeBegin;
                tr.appendChild(tdTimeBegin);
                //

                // appendChild de l'heure de fin
                const tdTimeEnd = document.createElement('td');
                tdTimeEnd.textContent = timeEnd;
                tr.appendChild(tdTimeEnd);
                //

                // je récupère simplement le jour et le mois dans le format FR
                const dateOfMeeting = timeToStart.toLocaleDateString("fr-FR", {month: "2-digit", day: "2-digit"})
                // je vérifie si le fichier PDF existe déjà dans les occurrences
                if (fileOccurrences[fileName]) {
                    // Le fichier existe déjà, j'utilise le compteur actuel pour incrémenter les champs
                    ADMINAME = `NOM_PRENOM${fileOccurrences[fileName]}`;
                    CONTACT = `CONTACT${fileOccurrences[fileName]}`;
                    HORAIRE = `HORAIRE${fileOccurrences[fileName]}`;

                    allInputsToFill[fileName][ADMINAME] = adminName;
                    allInputsToFill[fileName][CONTACT] = adminName;
                    allInputsToFill[fileName][HORAIRE] = timeBegin + "\n" + timeEnd;
                    fileOccurrences[fileName]++; // j'incrémente le compteur pour la prochaine occurrence
                } else {
                    allInputsToFill[fileName] = {};
                    allInputsToFill[fileName]["DATE1"] = dateOfMeeting;
                    allInputsToFill[fileName]["NOM_PRENOM1"] = adminName;
                    allInputsToFill[fileName]["CONTACT1"] = adminName;
                    allInputsToFill[fileName]["HORAIRE1"] = timeBegin + "\n" + timeEnd;

                    // je définis le compteur à 2 pour la prochaine occurrence
                    fileOccurrences[fileName] = 2;
                }
                exceltable.appendChild(tr);
            });

            fetch('/.netlify/functions/pdf-gen', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(allInputsToFill)
            })
                .then(response => response.blob())
                .then(blob => {
                    const fileURL = URL.createObjectURL(blob);
                    window.open(fileURL);
                })
                .catch(error => {
                    console.error(error);
                });
        })
    })
</script>
</html>